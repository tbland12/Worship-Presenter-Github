"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PublisherGithub = void 0;
const node_path_1 = __importDefault(require("node:path"));
const publisher_base_1 = require("@electron-forge/publisher-base");
const request_error_1 = require("@octokit/request-error");
const chalk_1 = __importDefault(require("chalk"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const log_symbols_1 = __importDefault(require("log-symbols"));
const mime_types_1 = __importDefault(require("mime-types"));
const github_1 = __importDefault(require("./util/github"));
const no_release_error_1 = __importDefault(require("./util/no-release-error"));
class PublisherGithub extends publisher_base_1.PublisherBase {
    constructor() {
        super(...arguments);
        this.name = 'github';
    }
    async publish({ makeResults, setStatusLine, }) {
        const { config } = this;
        const perReleaseArtifacts = {};
        for (const makeResult of makeResults) {
            const release = makeResult.packageJSON.version;
            if (!perReleaseArtifacts[release]) {
                perReleaseArtifacts[release] = [];
            }
            perReleaseArtifacts[release].push(makeResult);
        }
        if (!(config.repository &&
            typeof config.repository === 'object' &&
            config.repository.owner &&
            config.repository.name)) {
            throw new Error('In order to publish to GitHub, you must set the "repository.owner" and "repository.name" properties in your Forge config. See the docs for more info');
        }
        const github = new github_1.default(config.authToken, true, config.octokitOptions);
        github.getGitHub();
        for (const releaseVersion of Object.keys(perReleaseArtifacts)) {
            let release;
            const artifacts = perReleaseArtifacts[releaseVersion];
            const releaseName = `${config.tagPrefix ?? 'v'}${releaseVersion}`;
            setStatusLine(`Searching for target release: ${releaseName}`);
            try {
                release = (await github.getGitHub().repos.listReleases({
                    owner: config.repository.owner,
                    repo: config.repository.name,
                    per_page: 100,
                })).data.find((testRelease) => testRelease.tag_name === releaseName);
                if (!release) {
                    throw new no_release_error_1.default(404);
                }
            }
            catch (err) {
                if (err instanceof no_release_error_1.default && err.code === 404) {
                    // Release does not exist, let's make it
                    release = (await github.getGitHub().repos.createRelease({
                        owner: config.repository.owner,
                        repo: config.repository.name,
                        tag_name: releaseName,
                        name: releaseName,
                        draft: config.draft !== false,
                        prerelease: config.prerelease === true,
                        generate_release_notes: config.generateReleaseNotes === true,
                    })).data;
                }
                else {
                    // Unknown error
                    throw err;
                }
            }
            let uploaded = 0;
            const updateUploadStatus = () => {
                setStatusLine(`Uploading distributable (${uploaded}/${artifacts.length} to ${releaseName})`);
            };
            updateUploadStatus();
            await Promise.all(artifacts
                .flatMap((artifact) => artifact.artifacts)
                .map(async (artifactPath) => {
                const done = () => {
                    uploaded += 1;
                    updateUploadStatus();
                };
                const artifactName = node_path_1.default.basename(artifactPath);
                const sanitizedArtifactName = github_1.default.sanitizeName(artifactName);
                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                const asset = release.assets.find((item) => item.name === sanitizedArtifactName);
                if (asset !== undefined) {
                    if (config.force === true) {
                        await github.getGitHub().repos.deleteReleaseAsset({
                            owner: config.repository.owner,
                            repo: config.repository.name,
                            asset_id: asset.id,
                        });
                    }
                    else {
                        return done();
                    }
                }
                try {
                    const { data: uploadedAsset } = await github
                        .getGitHub()
                        .repos.uploadReleaseAsset({
                        owner: config.repository.owner,
                        repo: config.repository.name,
                        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                        release_id: release.id,
                        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
                        url: release.upload_url,
                        // https://github.com/octokit/rest.js/issues/1645
                        data: (await fs_extra_1.default.readFile(artifactPath)),
                        headers: {
                            'content-type': mime_types_1.default.lookup(artifactPath) || 'application/octet-stream',
                            'content-length': (await fs_extra_1.default.stat(artifactPath)).size,
                        },
                        name: artifactName,
                    });
                    if (uploadedAsset.name !== sanitizedArtifactName) {
                        // There's definitely a bug with GitHub.sanitizeName
                        console.warn(log_symbols_1.default.warning, chalk_1.default.yellow(`Expected artifact's name to be '${sanitizedArtifactName}' - got '${uploadedAsset.name}'`));
                    }
                }
                catch (err) {
                    // If an asset with that name already exists, it's either a bug with GitHub.sanitizeName
                    // where it did not sanitize the artifact name in the same way as GitHub did, or there
                    // was simply a race condition with uploading artifacts with the same name
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    if (err instanceof request_error_1.RequestError &&
                        err.status === 422 &&
                        err.response?.data?.errors?.[0].code ===
                            'already_exists') {
                        console.error(`Asset with name '${artifactName}' already exists - there may be a bug with Forge's GitHub.sanitizeName util`);
                    }
                    throw err;
                }
                return done();
            }));
        }
    }
}
exports.default = PublisherGithub;
exports.PublisherGithub = PublisherGithub;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHVibGlzaGVyR2l0aHViLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1B1Ymxpc2hlckdpdGh1Yi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSwwREFBNkI7QUFFN0IsbUVBR3dDO0FBRXhDLDBEQUFzRDtBQUV0RCxrREFBMEI7QUFDMUIsd0RBQTBCO0FBQzFCLDhEQUFxQztBQUNyQyw0REFBOEI7QUFHOUIsMkRBQW1DO0FBQ25DLCtFQUFxRDtBQVlyRCxNQUFxQixlQUFnQixTQUFRLDhCQUFvQztJQUFqRjs7UUFDRSxTQUFJLEdBQUcsUUFBUSxDQUFDO0lBc0tsQixDQUFDO0lBcEtDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFDWixXQUFXLEVBQ1gsYUFBYSxHQUNJO1FBQ2pCLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFFeEIsTUFBTSxtQkFBbUIsR0FFckIsRUFBRSxDQUFDO1FBRVAsS0FBSyxNQUFNLFVBQVUsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNyQyxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztZQUMvQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDbEMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3BDLENBQUM7WUFDRCxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUVELElBQ0UsQ0FBQyxDQUNDLE1BQU0sQ0FBQyxVQUFVO1lBQ2pCLE9BQU8sTUFBTSxDQUFDLFVBQVUsS0FBSyxRQUFRO1lBQ3JDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSztZQUN2QixNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FDdkIsRUFDRCxDQUFDO1lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FDYixzSkFBc0osQ0FDdkosQ0FBQztRQUNK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